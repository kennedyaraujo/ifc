<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="font/material-icons.css"> 
</head>
<body> 

<video id="video" autoplay width="640" height="480"></video>

<div id="campo">
  <canvas id="video-com-flip" width="640" height="480"></canvas>
  <div id="quadrado"></div>
</div>


<style type="text/css">
div#campo{
  position: absolute;
  border: 2px;
}
div#quadrado{
  position: absolute;
  width: 50px;
  height: 50px;
  background:red;
  top: 50px;
  left: 50px;
}
canvas#canvas-source{
  position: relative;
  top: 0;
  left: 0;
  z-index: -1;
}
</style>
<canvas id="mapa-de-movimento" width="640" height="480"></canvas>

<script>

window.$ = (query, ctx = document) => ctx.querySelector(query);

document.addEventListener("DOMContentLoaded", function(){

const video = $('#video');
//não realizar captura de audio e apenas do video
const constraints = { audio: false, video: true }; 

  
//responsável por solicitar a abertura da camera e capturar o stream de vídeo
navigator.mediaDevices.getUserMedia(constraints)
.then(function(stream) {
  video.srcObject = stream;
  console.log(stream);
  video.onloadedmetadata = function(e) {
    video.play();
  };//onloadedmetadata        
})
.catch(function(err) {
  console.log(err.name + ": " + err.message);
});

//captura canvas
var videoComFlip = $("#video-com-flip");
var mapaDeMovimento = $("#mapa-de-movimento");
//cria a base para edição do canvas com as imagens capturadas
var contextoVideoComFlip = videoComFlip.getContext('2d');
var contextoMapaDeMovimento = mapaDeMovimento.getContext('2d');

//flip horizontal para facilitar a usabilidade interação por gestos
contextoVideoComFlip.translate(videoComFlip.width, 0);
contextoVideoComFlip.scale(-1, 1);

//cria a imagem preto e branco que representa o movimento
function montarMapaDeMovimento(target, data1, data2) {
  if (data1.length != data2.length) return null;
  let i = 0;
  let quantidadeDePixels = data1.length * 0.25;
  while (i < quantidadeDePixels) {
    var media1 = (data1[4*i] + data1[4*i+1] + data1[4*i+2]) / 3;
    var media2 = (data2[4*i] + data2[4*i+1] + data2[4*i+2]) / 3;
    var diff = Math.abs(media1 - media2) > 21 ? 255 : 0;
    target[4*i] = diff;
    target[4*i+1] = diff;
    target[4*i+2] = diff;
    target[4*i+3] = 255;
    ++i;
  }
}

function atualizarMapaDeMovimento() {
  var width = videoComFlip.width;
  var height = videoComFlip.height;
  //capturar dados da imagem vinda da webcam
  sourceData = contextoVideoComFlip.getImageData(0, 0, width, height);
  //se ñ houver registro da imagem anterior crie o local para armazena-la
  if (typeof lastImageData === 'undefined') 
    lastImageData = contextoVideoComFlip.getImageData(0, 0, width, height);
  //criar imagem para receber o resultado da subtração da imagem atual com a anterior
  var blendedData = contextoVideoComFlip.createImageData(width, height);
  //subtrair pixels das duas imagens
  montarMapaDeMovimento(blendedData.data, sourceData.data, lastImageData.data);
  //colocar a imagem resultante no canvas do mapa de movimento para ser mostrada
  contextoMapaDeMovimento.putImageData(blendedData, 0, 0);
  //atualizar imagem anterior colocando os dados da imagem atual
  lastImageData = sourceData;
}// end blend()
 
const atualizacao =  setInterval(function(){
  //ela pega o conteudo do video e joga no canvas invertido para melhorar a percepção do usuaroo
  contextoVideoComFlip.drawImage(video, 0, 0, video.width, video.height);
  atualizarMapaDeMovimento();

},1000/32);// end setInterval atualizacao

});//domcontent load
</script>
</body>
</html>